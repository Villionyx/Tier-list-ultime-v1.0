<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tier List Universelle</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: white;
    color: black;
    margin: 0; padding: 0;
    display: flex; flex-direction: column; align-items: center;
  }
  .dark-mode {
    background-color: #121212;
    color: white;
  }
  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 10px;
    justify-content: center;
  }
  .upload-zone, .trash-zone {
    border: 2px dashed gray;
    padding: 10px;
    width: 200px;
    min-height: 100px;
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    justify-content: flex-start;
    align-items: center;
    overflow-x: auto;
  }
  .table-container {
    overflow-x: auto;
    margin: 20px;
    width: 100%;
    max-width: 800px;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    table-layout: fixed;
  }
  th, td {
    border: 1px solid gray;
    width: 120px;
    height: 120px;
    text-align: center;
    vertical-align: middle;
    position: relative;
    overflow-x: auto;
    padding: 5px;
  }
  th {
    background-color: #FFD700; /* default yellow for tiers */
    cursor: default;
  }
  th.class-header {
    background-color: #f0f0f0;
  }
  th.tier-header {
    cursor: default;
  }
  .footer {
    position: fixed;
    bottom: 5px;
    right: 5px;
    font-size: 10px;
  }
  img {
    max-width: 90px;
    max-height: 90px;
    cursor: grab;
    margin-right: 5px;
  }
  select.color-picker {
    position: absolute;
    bottom: 5px;
    left: 5px;
  }
</style>
</head>
<body>

<h1 id="title" contenteditable="true">Ma Tier List</h1>

<div id="pub-zone" style="background:#f0f0f0; padding:5px; width:100%; text-align:center;">
  <!-- Zone pour pub future -->
  Espace pub
</div>

<div class="controls">
  <input type="file" id="fileUpload" accept="image/*" multiple />
  <button id="addTier">Ajouter Tier</button>
  <button id="removeTier">Retirer Tier</button>
  <button id="addClass">Ajouter Classe</button>
  <button id="removeClass">Retirer Classe</button>
  <button id="toggleTheme">Mode Sombre/Clair</button>
  <button id="download">Télécharger Image</button>
  <button id="reset">Reset</button>
  <button id="musicBtn">Activer la musique</button>
</div>

<div style="display:flex; gap:20px; flex-wrap:wrap; justify-content:center; margin-top: 10px;">
  <div>
    <h3>Zone Upload</h3>
    <div id="uploadZone" class="upload-zone"></div>
  </div>
  <div>
    <h3>Poubelle</h3>
    <div id="trashZone" class="trash-zone"></div>
  </div>
</div>

<div class="table-container">
  <table id="tierTable">
    <thead>
      <tr>
        <th class="corner-cell"></th>
        <th class="class-header" contenteditable="true">Classe 1</th>
        <th class="class-header" contenteditable="true">Classe 2</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <th class="tier-header" contenteditable="true" style="background:#FFD700;">
          S
          <select class="color-picker" title="Changer couleur tier">
            <option value="#FFD700" selected>Jaune</option>
            <option value="#C0C0C0">Argent</option>
            <option value="#CD7F32">Bronze</option>
            <option value="#FF6347">Tomate</option>
            <option value="#87CEFA">Bleu clair</option>
            <option value="#90EE90">Vert clair</option>
            <option value="#D3D3D3">Gris clair</option>
          </select>
        </th>
        <td></td>
        <td></td>
      </tr>
      <tr>
        <th class="tier-header" contenteditable="true" style="background:#C0C0C0;">
          A
          <select class="color-picker" title="Changer couleur tier">
            <option value="#FFD700">Jaune</option>
            <option value="#C0C0C0" selected>Argent</option>
            <option value="#CD7F32">Bronze</option>
            <option value="#FF6347">Tomate</option>
            <option value="#87CEFA">Bleu clair</option>
            <option value="#90EE90">Vert clair</option>
            <option value="#D3D3D3">Gris clair</option>
          </select>
        </th>
        <td></td>
        <td></td>
      </tr>
    </tbody>
  </table>
</div>

<audio id="background-music" src="musique.mp3" loop></audio>

<div class="footer">Made by Villio</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
  const uploadZone = document.getElementById("uploadZone");
  const trashZone = document.getElementById("trashZone");
  const table = document.getElementById("tierTable").getElementsByTagName("tbody")[0];
  const fileUpload = document.getElementById("fileUpload");
  const music = document.getElementById("background-music");
  const musicBtn = document.getElementById("musicBtn");

  // Générer un ID unique pour chaque image
  function generateID() {
    return "id-" + Math.random().toString(36).substr(2, 9);
  }

  // Ajout des images uploadées dans la zone upload
  fileUpload.addEventListener("change", (e) => {
    for (const file of e.target.files) {
      const reader = new FileReader();
      reader.onload = function (event) {
        const img = document.createElement("img");
        img.src = event.target.result;
        img.draggable = true;
        img.dataset.id = generateID();
        img.addEventListener("dragstart", dragStart);
        uploadZone.appendChild(img);
      };
      reader.readAsDataURL(file);
    }
    fileUpload.value = ""; // Reset input pour pouvoir uploader même fichier à nouveau
  });

  // Gestion du drag start
  function dragStart(e) {
    e.dataTransfer.setData("text/plain", e.target.src);
    e.dataTransfer.setData("text/id", e.target.dataset.id);
    e.dataTransfer.effectAllowed = "move";
    e.target.classList.add("dragging");
  }

  // Empêcher drop sur th (tiers & classes)
  function dragOverDeny(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = "none";
  }
  function dropDeny(e) {
    e.preventDefault();
  }

  // Autoriser drop sur uploadZone, trashZone, td (cases du tableau)
  function dragOverAllow(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = "move";
  }

  // Fonction drop image autorisé (uploadZone, tbody td)
  function dropImageAllow(e) {
    e.preventDefault();
    const src = e.dataTransfer.getData("text/plain");
    const draggedId = e.dataTransfer.getData("text/id");
    if (!src) return;

    // Si on a l'ID de l'image déplacée, on déplace l'image existante
    if (draggedId) {
      const draggedImg = document.querySelector(`img[data-id="${draggedId}"]`);
      if (draggedImg) {
        // Si drop sur uploadZone ou td, on déplace l'image existante
        e.target.appendChild(draggedImg);
      }
      return;
    }

    // Sinon (ex: drag depuis fichier), créer une nouvelle image
    const img = document.createElement("img");
    img.src = src;
    img.draggable = true;
    img.dataset.id = generateID();
    img.addEventListener("dragstart", dragStart);
    e.target.appendChild(img);
  }

  // Interdire drop sur th (tiers et classes)
  document.querySelectorAll("th").forEach((th) => {
    th.addEventListener("dragover", dragOverDeny);
    th.addEventListener("drop", dropDeny);
  });

  // Zones autorisant le drop (uploadZone, trashZone, tbody td)
  uploadZone.addEventListener("dragover", dragOverAllow);
  uploadZone.addEventListener("drop", dropImageAllow);

  trashZone.addEventListener("dragover", dragOverAllow);
  trashZone.addEventListener("drop", (e) => {
    e.preventDefault();
    const draggedId = e.dataTransfer.getData("text/id");
    if (!draggedId) return;
    const imgToRemove = document.querySelector(`img[data-id="${draggedId}"]`);
    if (imgToRemove) imgToRemove.remove();
  });

  // Ajout drop sur toutes les cases td
  document.querySelectorAll("tbody td").forEach((td) => {
    td.addEventListener("dragover", dragOverAllow);
    td.addEventListener("drop", dropImageAllow);
  });

  // Boutons gestion tiers/classes

  // Ajouter un tier (ligne)
  document.getElementById("addTier").addEventListener("click", () => {
    const nbClasses = table.rows[0].cells.length - 1; // -1 pour la colonne tiers
    const tr = document.createElement("tr");

    // Colonne tiers avec titre editable et select couleur
    const th = document.createElement("th");
    th.classList.add("tier-header");
    th.contentEditable = "true";
    th.style.backgroundColor = "#FFD700";
    th.textContent = "Nouveau Tier";

    // Select couleurs principales/secondaires
    const select = document.createElement("select");
    select.classList.add("color-picker");
    const colors = [
      { name: "Jaune", val: "#FFD700" },
      { name: "Argent", val: "#C0C0C0" },
      { name: "Bronze", val: "#CD7F32" },
      { name: "Tomate", val: "#FF6347" },
      { name: "Bleu clair", val: "#87CEFA" },
      { name: "Vert clair", val: "#90EE90" },
      { name: "Gris clair", val: "#D3D3D3" },
    ];
    colors.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.val;
      opt.textContent = c.name;
      if (c.val === "#FFD700") opt.selected = true;
      select.appendChild(opt);
    });
    select.title = "Changer couleur tier";
    select.addEventListener("change", (e) => {
      th.style.backgroundColor = e.target.value;
    });
    th.appendChild(select);
    tr.appendChild(th);

    // Colonnes classes vides
    for (let i = 0; i < nbClasses; i++) {
      const td = document.createElement("td");
      tr.appendChild(td);
      // Autoriser drop sur les nouvelles td
      td.addEventListener("dragover", dragOverAllow);
      td.addEventListener("drop", dropImageAllow);
    }
    table.appendChild(tr);
  });

  // Retirer un tier (dernière ligne)
  document.getElementById("removeTier").addEventListener("click", () => {
    if (table.rows.length > 1) {
      table.deleteRow(table.rows.length - 1);
    }
  });

  // Ajouter une classe (colonne)
  document.getElementById("addClass").addEventListener("click", () => {
    const theadRow = document.querySelector("#tierTable thead tr");
    const th = document.createElement("th");
    th.classList.add("class-header");
    th.contentEditable = "true";
    th.textContent = "Nouvelle Classe";
    theadRow.appendChild(th);

    // Ajouter une cellule td vide dans chaque ligne du tbody
    for (let i = 0; i < table.rows.length; i++) {
      const td = document.createElement("td");
      table.rows[i].appendChild(td);
      td.addEventListener("dragover", dragOverAllow);
      td.addEventListener("drop", dropImageAllow);
    }
  });

  // Retirer une classe (dernière colonne)
  document.getElementById("removeClass").addEventListener("click", () => {
    const theadRow = document.querySelector("#tierTable thead tr");
    if (theadRow.cells.length > 2) {
      theadRow.deleteCell(theadRow.cells.length - 1);
      for (let i = 0; i < table.rows.length; i++) {
        table.rows[i].deleteCell(table.rows[i].cells.length - 1);
      }
    }
  });

  // Modifier couleur tiers existants avec select déjà présent
  function initColorPickers() {
    document.querySelectorAll("th.tier-header").forEach(th => {
      const select = th.querySelector("select.color-picker");
      if (select) {
        select.addEventListener("change", (e) => {
          th.style.backgroundColor = e.target.value;
        });
      }
    });
  }
  initColorPickers();

  // Mode sombre / clair
  document.getElementById("toggleTheme").addEventListener("click", () => {
    document.body.classList.toggle("dark-mode");
  });

  // Téléchargement image
  document.getElementById("download").addEventListener("click", () => {
    html2canvas(table).then(canvas => {
      const link = document.createElement("a");
      link.download = "tierlist.png";
      link.href = canvas.toDataURL();
      link.click();
    });
  });

  // Reset (vider upload, poubelle, remettre table à 2 tiers x 2 classes)
  document.getElementById("reset").addEventListener("click", () => {
    uploadZone.innerHTML = "";
    trashZone.innerHTML = "";
    // Reset table
    while (table.firstChild) table.removeChild(table.firstChild);

    // Remplir table par défaut (2 tiers, 2 classes)
    // entête classes
    const theadRow = document.querySelector("#tierTable thead tr");
    while (theadRow.cells.length > 1) theadRow.deleteCell(1);
    const class1 = document.createElement("th");
    class1.classList.add("class-header");
    class1.contentEditable = "true";
    class1.textContent = "Classe 1";
    theadRow.appendChild(class1);
    const class2 = document.createElement("th");
    class2.classList.add("class-header");
    class2.contentEditable = "true";
    class2.textContent = "Classe 2";
    theadRow.appendChild(class2);

    // tiers S et A
    function createTierRow(name, color) {
      const tr = document.createElement("tr");
      const th = document.createElement("th");
      th.classList.add("tier-header");
      th.contentEditable = "true";
      th.style.backgroundColor = color;
      th.textContent = name;
      const select = document.createElement("select");
      select.classList.add("color-picker");
      const colors = [
        { name: "Jaune", val: "#FFD700" },
        { name: "Argent", val: "#C0C0C0" },
        { name: "Bronze", val: "#CD7F32" },
        { name: "Tomate", val: "#FF6347" },
        { name: "Bleu clair", val: "#87CEFA" },
        { name: "Vert clair", val: "#90EE90" },
        { name: "Gris clair", val: "#D3D3D3" },
      ];
      colors.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.val;
        opt.textContent = c.name;
        if (c.val === color) opt.selected = true;
        select.appendChild(opt);
      });
      select.title = "Changer couleur tier";
      select.addEventListener("change", (e) => {
        th.style.backgroundColor = e.target.value;
      });
      th.appendChild(select);
      tr.appendChild(th);
      for(let i=0; i<2; i++) {
        const td = document.createElement("td");
        td.addEventListener("dragover", dragOverAllow);
        td.addEventListener("drop", dropImageAllow);
        tr.appendChild(td);
      }
      table.appendChild(tr);
    }
    createTierRow("S", "#FFD700");
    createTierRow("A", "#C0C0C0");
  });

  // Activer musique
  musicBtn.addEventListener("click", () => {
    if (music.paused) {
      music.play();
      musicBtn.textContent = "Pause la musique";
    } else {
      music.pause();
      musicBtn.textContent = "Activer la musique";
    }
  });
</script>

</body>
</html>
